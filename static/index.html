<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Hour Games</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin: 20px 0 10px;
            font-size: 2em;
            text-align: center;
            color: #e94560;
        }
        h1 span { color: #e0e0e0; font-size: 0.5em; display: block; font-weight: normal; }

        /* Screens */
        .screen { display: none; width: 100%; max-width: 700px; padding: 20px; }
        .screen.active { display: block; }

        /* Hub */
        #hub { text-align: center; }
        .game-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 600px;
        }
        .game-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px 24px;
            width: 250px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .game-card:hover {
            transform: translateY(-4px);
            border-color: #e94560;
            box-shadow: 0 8px 24px rgba(233,69,96,0.2);
        }
        .game-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .game-card.disabled:hover {
            transform: none;
            border-color: rgba(255,255,255,0.1);
            box-shadow: none;
        }
        .game-card .game-icon { font-size: 3em; margin-bottom: 12px; }
        .game-card .game-title { font-size: 1.3em; font-weight: bold; color: #e94560; margin-bottom: 8px; }
        .game-card .game-desc { font-size: 0.9em; color: #999; }
        .game-card .game-badge {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .badge-ready { background: #2ecc71; color: #fff; }
        .badge-soon { background: #555; color: #ccc; }

        /* Lobby */
        #lobby { text-align: center; }
        #lobby input, #lobby select, #lobby button {
            display: block;
            width: 100%;
            max-width: 350px;
            margin: 10px auto;
            padding: 12px 16px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #333;
        }
        #lobby input, #lobby select {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        #lobby button {
            background: #e94560;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #lobby button:hover { background: #c73651; }
        .room-list { margin: 20px auto; max-width: 400px; text-align: left; }
        .room-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 16px;
            margin: 6px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item button {
            background: #0f3460;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: #999;
            cursor: pointer;
            font-size: 0.95em;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }
        .back-link:hover { color: #e94560; }

        /* Waiting room */
        #waiting { text-align: center; }
        .player-list { margin: 20px auto; max-width: 300px; }
        .player-list div { padding: 8px; background: rgba(255,255,255,0.05); margin: 4px 0; border-radius: 6px; }

        /* Game */
        #game { text-align: center; }
        .info-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            margin: 10px 0;
            font-size: 1.1em;
        }
        .info-item { background: rgba(255,255,255,0.08); padding: 8px 16px; border-radius: 8px; }
        .info-item .label { font-size: 0.75em; color: #999; }

        .pile {
            margin: 20px auto;
            padding: 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            min-height: 100px;
        }
        .pile-card {
            display: inline-block;
            width: 60px;
            height: 85px;
            background: linear-gradient(135deg, #533483, #0f3460);
            color: #fff;
            border-radius: 8px;
            line-height: 85px;
            font-size: 1.4em;
            font-weight: bold;
            margin: 4px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .hand {
            margin: 20px auto;
            padding: 20px;
            background: rgba(233, 69, 96, 0.1);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
        }
        .hand h3 { margin-bottom: 12px; color: #e94560; }
        .card-btn {
            display: inline-block;
            width: 70px;
            height: 100px;
            background: linear-gradient(135deg, #e94560, #c73651);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            margin: 6px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            line-height: 100px;
        }
        .card-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(233,69,96,0.4);
        }

        .star-btn {
            background: #f5a623;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        .star-btn:hover { background: #d4911e; }
        .star-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .next-btn {
            background: #2ecc71;
            color: #fff;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 16px;
        }
        .next-btn:hover { background: #27ae60; }

        /* Placeholder screen */
        #placeholder { text-align: center; }
        .placeholder-content {
            margin: 40px auto;
            padding: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            max-width: 400px;
        }
        .placeholder-content .placeholder-icon { font-size: 4em; margin-bottom: 16px; }
        .placeholder-content h2 { color: #e94560; margin-bottom: 12px; }
        .placeholder-content p { color: #999; margin-bottom: 20px; }

        /* Log */
        #log {
            max-width: 700px;
            width: 100%;
            margin: 16px auto;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        #log div { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-error { color: #e94560; }
        .log-success { color: #2ecc71; }
        .log-info { color: #f5a623; }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .overlay.active { display: flex; }
        .overlay-content {
            background: #16213e;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }
        .overlay-content h2 { font-size: 2em; margin-bottom: 16px; }
        .overlay-content button {
            margin-top: 16px;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üéâ Happy Hour Games <span>Team Game Night Platform</span></h1>

    <!-- Hub Screen -->
    <div id="hub" class="screen active">
        <h2>Choose a Game</h2>
        <div class="game-grid">
            <div class="game-card" role="button" tabindex="0" onclick="selectGame('the_mind')" onkeydown="if(event.key==='Enter')selectGame('the_mind')">
                <div class="game-icon">üß†</div>
                <div class="game-title">The Mind</div>
                <div class="game-desc">Play cards 1‚Äì100 in ascending order ‚Äî without talking! A cooperative test of intuition.</div>
                <span class="game-badge badge-ready">Ready to Play</span>
            </div>
            <div class="game-card disabled" role="button" aria-disabled="true" tabindex="-1">
                <div class="game-icon">ü™µ</div>
                <div class="game-title">Ore, Wood &amp; Offer Letters</div>
                <div class="game-desc">A resource trading and negotiation game. Trade your way to victory!</div>
                <span class="game-badge badge-soon">Coming Soon</span>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="screen">
        <button class="back-link" onclick="backToHub()">‚Üê Back to Games</button>
        <h2 id="lobbyTitle">Enter the Lobby</h2>
        <input type="text" id="playerName" placeholder="Your name" maxlength="20">
        <input type="text" id="roomId" placeholder="Room name" maxlength="20">
        <select id="numPlayers">
            <option value="2">2 Players</option>
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
        </select>
        <button onclick="createRoom()">Create Room</button>
        <button onclick="refreshRooms()" style="background:#0f3460;">Refresh Rooms</button>
        <div id="roomList" class="room-list"></div>
    </div>

    <!-- Placeholder Screen (for coming-soon games) -->
    <div id="placeholder" class="screen">
        <button class="back-link" onclick="backToHub()">‚Üê Back to Games</button>
        <div class="placeholder-content">
            <div class="placeholder-icon">ü™µ</div>
            <h2>Ore, Wood &amp; Offer Letters</h2>
            <p>This game is coming soon! Check back later for updates.</p>
            <button onclick="backToHub()" style="background:#e94560;color:#fff;padding:12px 28px;border:none;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;">Back to Games</button>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting" class="screen">
        <h2>Waiting for Players...</h2>
        <p id="waitingInfo"></p>
        <div id="playerList" class="player-list"></div>
    </div>

    <!-- Game Screen -->
    <div id="game" class="screen">
        <div class="info-bar">
            <div class="info-item"><div class="label">Level</div><span id="levelDisplay">1</span></div>
            <div class="info-item"><div class="label">Lives</div><span id="livesDisplay">‚ù§Ô∏è 2</span></div>
            <div class="info-item"><div class="label">Stars</div><span id="starsDisplay">‚≠ê 1</span></div>
            <div class="info-item"><div class="label">Cards Left</div><span id="cardsLeft">0</span></div>
        </div>

        <div class="pile">
            <h3>Played Cards</h3>
            <div id="playedPile"></div>
        </div>

        <div class="hand">
            <h3>Your Hand</h3>
            <div id="yourHand"></div>
        </div>

        <button class="star-btn" id="starBtn" onclick="useStar()">‚≠ê Use Throwing Star</button>
        <button class="next-btn" id="nextBtn" onclick="nextLevel()" style="display:none;">Next Level ‚û°Ô∏è</button>
    </div>

    <!-- Game Over Overlay -->
    <div id="gameOverOverlay" class="overlay">
        <div class="overlay-content">
            <h2 id="gameOverTitle"></h2>
            <p id="gameOverMsg"></p>
            <button onclick="backToHub()" style="background:#e94560;color:#fff;">Back to Games</button>
        </div>
    </div>

    <!-- Log -->
    <div id="log"></div>

    <script>
        let ws = null;
        let myPlayerId = null;
        let myRoomId = null;
        let selectedGameType = null;

        function getWsUrl() {
            const loc = window.location;
            const proto = loc.protocol === 'https:' ? 'wss:' : 'ws:';
            return proto + '//' + loc.host;
        }

        function connect() {
            return new Promise((resolve, reject) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    resolve();
                    return;
                }
                ws = new WebSocket(getWsUrl());
                ws.onopen = () => resolve();
                ws.onerror = (e) => reject(e);
                ws.onclose = () => {
                    addLog('Disconnected from server', 'error');
                    ws = null;
                };
                ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
            });
        }

        function send(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(obj));
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function addLog(msg, type) {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.className = type ? 'log-' + type : '';
            div.textContent = msg;
            log.prepend(div);
            if (log.children.length > 50) log.removeChild(log.lastChild);
        }

        function selectGame(gameType) {
            if (gameType === 'ore_wood_offer_letters') {
                showScreen('placeholder');
                return;
            }
            selectedGameType = gameType;
            const titles = { 'the_mind': 'üß† The Mind ‚Äî Lobby' };
            document.getElementById('lobbyTitle').textContent = titles[gameType] || 'Lobby';
            showScreen('lobby');
            refreshRooms();
        }

        function backToHub() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            if (ws) ws.close();
            ws = null;
            myPlayerId = null;
            myRoomId = null;
            selectedGameType = null;
            showScreen('hub');
        }

        async function createRoom() {
            await connect();
            const name = document.getElementById('playerName').value.trim() || 'Player';
            const roomId = document.getElementById('roomId').value.trim();
            const numPlayers = document.getElementById('numPlayers').value;
            if (!roomId) { addLog('Please enter a room name', 'error'); return; }
            send({ action: 'create_room', room_id: roomId, num_players: parseInt(numPlayers), name: name, game_type: selectedGameType });
        }

        async function joinRoom(roomId) {
            await connect();
            const name = document.getElementById('playerName').value.trim() || 'Player';
            send({ action: 'join_room', room_id: roomId, name: name });
        }

        async function refreshRooms() {
            await connect();
            send({ action: 'list_rooms' });
        }

        function playCard(card) {
            send({ action: 'play_card', card: card });
        }

        function useStar() {
            send({ action: 'use_star' });
        }

        function nextLevel() {
            send({ action: 'next_level' });
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'room_joined':
                    myPlayerId = msg.player_id;
                    myRoomId = msg.room_id;
                    selectedGameType = msg.game_type || selectedGameType;
                    document.getElementById('waitingInfo').textContent =
                        'Room: ' + msg.room_id + ' ‚Äî ' + msg.current_players + '/' + msg.num_players + ' players';
                    showScreen('waiting');
                    addLog('Joined room ' + msg.room_id + ' as ' + msg.player_name, 'success');
                    break;

                case 'player_joined':
                    document.getElementById('waitingInfo').textContent =
                        'Room: ' + myRoomId + ' ‚Äî ' + msg.current_players + '/' + msg.num_players + ' players';
                    addLog(msg.player_name + ' joined the room', 'info');
                    break;

                case 'game_started':
                    showScreen('game');
                    addLog('Game started!', 'success');
                    break;

                case 'game_state':
                    updateGameUI(msg);
                    break;

                case 'card_played':
                    if (msg.success) {
                        addLog(msg.player_name + ' played card ' + msg.card, 'success');
                    } else {
                        addLog(msg.player_name + ' played ' + msg.card + ' out of order! ' + msg.message, 'error');
                    }
                    break;

                case 'star_used':
                    if (msg.success) {
                        let details = Object.values(msg.discarded).map(d => d.name + ': ' + d.card).join(', ');
                        addLog('Throwing star used! Discarded: ' + details, 'info');
                    }
                    break;

                case 'level_started':
                    document.getElementById('nextBtn').style.display = 'none';
                    addLog('Level ' + msg.level + ' started!', 'success');
                    break;

                case 'room_list':
                    renderRoomList(msg.rooms);
                    break;

                case 'player_left':
                    addLog(msg.player_name + ' left the room', 'error');
                    break;

                case 'error':
                    addLog(msg.message, 'error');
                    break;
            }
        }

        function updateGameUI(state) {
            if (!state || state.state === 'waiting') return;

            document.getElementById('levelDisplay').textContent = state.current_level;
            document.getElementById('livesDisplay').textContent = '‚ù§Ô∏è ' + state.lives;
            document.getElementById('starsDisplay').textContent = '‚≠ê ' + state.throwing_stars;
            document.getElementById('cardsLeft').textContent = state.cards_in_play;

            // Render played pile (show last 10 cards)
            const pile = document.getElementById('playedPile');
            const cards = state.played_pile || [];
            const recent = cards.slice(-10);
            pile.innerHTML = recent.map(c => '<div class="pile-card">' + c + '</div>').join('');

            // Render hand
            const hand = document.getElementById('yourHand');
            const myCards = state.your_hand || [];
            hand.innerHTML = myCards.map(c =>
                '<button class="card-btn" onclick="playCard(' + c + ')">' + c + '</button>'
            ).join('');

            // Star button
            const starBtn = document.getElementById('starBtn');
            starBtn.disabled = state.throwing_stars <= 0 || state.state !== 'in_progress';

            // Level complete
            const nextBtn = document.getElementById('nextBtn');
            if (state.state === 'level_complete') {
                nextBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'none';
            }

            // Game over
            if (state.state === 'game_won') {
                document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
                document.getElementById('gameOverMsg').textContent = 'Congratulations! You completed all 12 levels!';
                document.getElementById('gameOverOverlay').classList.add('active');
            } else if (state.state === 'game_lost') {
                document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
                document.getElementById('gameOverMsg').textContent = 'You ran out of lives. Better luck next time!';
                document.getElementById('gameOverOverlay').classList.add('active');
            }
        }

        function renderRoomList(rooms) {
            const list = document.getElementById('roomList');
            // Filter rooms to only show those matching the selected game type
            const filtered = rooms.filter(r => r.game_type === selectedGameType);
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;">No rooms available. Create one!</p>';
                return;
            }
            list.innerHTML = filtered.map(r => {
                const canJoin = !r.in_progress && r.current_players < r.num_players;
                return '<div class="room-item"><span>' + r.room_id + ' (' + r.current_players + '/' + r.num_players + ')' +
                    (r.in_progress ? ' - In Progress' : '') + '</span>' +
                    (canJoin ? '<button onclick="joinRoom(\'' + r.room_id + '\')">Join</button>' : '') +
                    '</div>';
            }).join('');
        }

        // No auto-connect on load ‚Äî user picks a game first from the hub
    </script>
</body>
</html>
