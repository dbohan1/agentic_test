<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Hour Games</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            margin: 20px 0 10px;
            font-size: 2em;
            text-align: center;
            color: #e94560;
        }
        h1 span { color: #e0e0e0; font-size: 0.5em; display: block; font-weight: normal; }

        /* Screens */
        .screen { display: none; width: 100%; max-width: 700px; padding: 20px; }
        .screen.active { display: block; }

        /* Hub */
        #hub { text-align: center; }
        .game-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px auto;
            max-width: 600px;
        }
        .game-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px 24px;
            width: 250px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .game-card:hover {
            transform: translateY(-4px);
            border-color: #e94560;
            box-shadow: 0 8px 24px rgba(233,69,96,0.2);
        }
        .game-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .game-card.disabled:hover {
            transform: none;
            border-color: rgba(255,255,255,0.1);
            box-shadow: none;
        }
        .game-card .game-icon { font-size: 3em; margin-bottom: 12px; }
        .game-card .game-title { font-size: 1.3em; font-weight: bold; color: #e94560; margin-bottom: 8px; }
        .game-card .game-desc { font-size: 0.9em; color: #999; }
        .game-card .game-badge {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .badge-ready { background: #2ecc71; color: #fff; }
        .badge-soon { background: #555; color: #ccc; }

        /* Lobby */
        #lobby { text-align: center; }
        #lobby input, #lobby select, #lobby button {
            display: block;
            width: 100%;
            max-width: 350px;
            margin: 10px auto;
            padding: 12px 16px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid #333;
        }
        #lobby input, #lobby select {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        #lobby button {
            background: #e94560;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #lobby button:hover { background: #c73651; }
        .room-list { margin: 20px auto; max-width: 400px; text-align: left; }
        .room-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 16px;
            margin: 6px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .room-item button {
            background: #0f3460;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: #999;
            cursor: pointer;
            font-size: 0.95em;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }
        .back-link:hover { color: #e94560; }

        /* Waiting room */
        #waiting { text-align: center; }
        .player-list { margin: 20px auto; max-width: 300px; }
        .player-list div { padding: 8px; background: rgba(255,255,255,0.05); margin: 4px 0; border-radius: 6px; }

        /* Game */
        #game { text-align: center; }
        .info-bar {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            margin: 10px 0;
            font-size: 1.1em;
        }
        .info-item { background: rgba(255,255,255,0.08); padding: 8px 16px; border-radius: 8px; }
        .info-item .label { font-size: 0.75em; color: #999; }

        .pile {
            margin: 20px auto;
            padding: 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            min-height: 100px;
        }
        .pile-card {
            display: inline-block;
            width: 60px;
            height: 85px;
            background: linear-gradient(135deg, #533483, #0f3460);
            color: #fff;
            border-radius: 8px;
            line-height: 85px;
            font-size: 1.4em;
            font-weight: bold;
            margin: 4px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .hand {
            margin: 20px auto;
            padding: 20px;
            background: rgba(233, 69, 96, 0.1);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 12px;
        }
        .hand h3 { margin-bottom: 12px; color: #e94560; }
        .card-btn {
            display: inline-block;
            width: 70px;
            height: 100px;
            background: linear-gradient(135deg, #e94560, #c73651);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            margin: 6px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            line-height: 100px;
        }
        .card-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(233,69,96,0.4);
        }

        .star-btn {
            background: #f5a623;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        .star-btn:hover { background: #d4911e; }
        .star-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .next-btn {
            background: #2ecc71;
            color: #fff;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 16px;
        }
        .next-btn:hover { background: #27ae60; }

        /* Placeholder screen */
        #placeholder { text-align: center; }
        .placeholder-content {
            margin: 40px auto;
            padding: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            max-width: 400px;
        }
        .placeholder-content .placeholder-icon { font-size: 4em; margin-bottom: 16px; }
        .placeholder-content h2 { color: #e94560; margin-bottom: 12px; }
        .placeholder-content p { color: #999; margin-bottom: 20px; }

        /* Log */
        #log {
            max-width: 700px;
            width: 100%;
            margin: 16px auto;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            max-height: 180px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        #log div { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-error { color: #e94560; }
        .log-success { color: #2ecc71; }
        .log-info { color: #f5a623; }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .overlay.active { display: flex; }
        .overlay-content {
            background: #16213e;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }
        .overlay-content h2 { font-size: 2em; margin-bottom: 16px; }
        .overlay-content button {
            margin-top: 16px;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }
        /* Azrok's Republic */
        #azrokGame { text-align: center; }

        .role-info {
            margin: 10px auto;
            padding: 12px 20px;
            background: rgba(233, 69, 96, 0.15);
            border: 2px solid rgba(233, 69, 96, 0.3);
            border-radius: 10px;
            max-width: 400px;
        }
        .role-info .role-label { font-size: 0.85em; color: #999; }
        .role-info .role-value { font-size: 1.1em; font-weight: bold; color: #e94560; }
        .role-info .sector-value { font-size: 1em; color: #f5a623; }

        .turn-info {
            margin: 12px auto;
            padding: 10px;
            font-size: 1.1em;
            max-width: 500px;
        }
        .turn-info.your-turn {
            background: rgba(46, 204, 113, 0.15);
            border: 2px solid rgba(46, 204, 113, 0.4);
            border-radius: 10px;
            color: #2ecc71;
            font-weight: bold;
        }

        .player-table {
            margin: 16px auto;
            border-collapse: collapse;
            max-width: 600px;
            width: 100%;
        }
        .player-table th, .player-table td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .player-table th { color: #999; font-size: 0.85em; text-transform: uppercase; }
        .player-table tr.active-player { background: rgba(233, 69, 96, 0.15); }
        .player-table tr.is-you { font-weight: bold; }

        .actions-panel {
            margin: 16px auto;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            max-width: 500px;
        }
        .actions-panel h3 { color: #e94560; margin-bottom: 12px; }
        .action-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn.invest { background: #0f3460; color: #fff; }
        .action-btn.improve { background: #533483; color: #fff; }
        .action-btn.tax { background: #f5a623; color: #1a1a2e; }
        .action-btn.powder { background: #c0392b; color: #fff; }
        .action-btn.dagger { background: #2ecc71; color: #fff; }
        .action-btn.end-turn { background: #7f8c8d; color: #fff; }
        .action-btn.resolve { background: #e94560; color: #fff; font-size: 1.1em; padding: 12px 28px; }
        .action-btn.next-round { background: #2ecc71; color: #fff; font-size: 1.1em; padding: 12px 28px; }

        .action-input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #e0e0e0;
            width: 80px;
            font-size: 0.95em;
        }
        .action-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #e0e0e0;
            font-size: 0.95em;
        }

        /* Team Supreme Scribbles */
        #scribblesGame { text-align: center; }

        .scribbles-word-card {
            margin: 20px auto;
            padding: 30px 40px;
            background: rgba(233, 69, 96, 0.15);
            border: 3px solid rgba(233, 69, 96, 0.4);
            border-radius: 16px;
            max-width: 450px;
        }
        .scribbles-word-card .word-label { font-size: 0.85em; color: #999; margin-bottom: 8px; }
        .scribbles-word-card .word-value { font-size: 2.2em; font-weight: bold; color: #e94560; }

        .scribbles-waiting-card {
            margin: 20px auto;
            padding: 30px 40px;
            background: rgba(15, 52, 96, 0.3);
            border: 3px solid rgba(15, 52, 96, 0.5);
            border-radius: 16px;
            max-width: 450px;
        }
        .scribbles-waiting-card .waiting-icon { font-size: 3em; margin-bottom: 10px; }
        .scribbles-waiting-card .waiting-text { font-size: 1.2em; color: #999; }
        .scribbles-waiting-card .drawer-name { font-size: 1.1em; color: #f5a623; font-weight: bold; }

        .scribbles-guess-area {
            margin: 16px auto;
            max-width: 450px;
            display: flex;
            gap: 8px;
        }
        .scribbles-guess-area input {
            flex: 1;
            padding: 12px 16px;
            font-size: 1.1em;
            border-radius: 8px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #e0e0e0;
        }
        .scribbles-guess-area button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            background: #2ecc71;
            color: #fff;
        }
        .scribbles-guess-area button:hover { background: #27ae60; }

        .scribbles-score-table {
            margin: 20px auto;
            border-collapse: collapse;
            max-width: 400px;
            width: 100%;
        }
        .scribbles-score-table th, .scribbles-score-table td {
            padding: 8px 14px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .scribbles-score-table th { color: #999; font-size: 0.85em; text-transform: uppercase; }
        .scribbles-score-table tr.is-drawer { background: rgba(233, 69, 96, 0.15); }
        .scribbles-score-table tr.is-you { font-weight: bold; }

        .scribbles-round-end {
            margin: 20px auto;
            padding: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            max-width: 400px;
        }
        .scribbles-round-end .revealed-word { font-size: 1.5em; font-weight: bold; color: #f5a623; margin: 8px 0; }
    </style>
</head>
<body>
    <h1>üéâ Happy Hour Games <span>Team Game Night Platform</span></h1>

    <!-- Hub Screen -->
    <div id="hub" class="screen active">
        <h2>Choose a Game</h2>
        <div class="game-grid">
            <div class="game-card" role="button" tabindex="0" onclick="selectGame('the_mind')" onkeydown="if(event.key==='Enter')selectGame('the_mind')">
                <div class="game-icon">üß†</div>
                <div class="game-title">The Mind</div>
                <div class="game-desc">Play cards 1‚Äì100 in ascending order ‚Äî without talking! A cooperative test of intuition.</div>
                <span class="game-badge badge-ready">Ready to Play</span>
            </div>
            <div class="game-card" role="button" tabindex="0" onclick="selectGame('azroks_republic')" onkeydown="if(event.key==='Enter')selectGame('azroks_republic')">
                <div class="game-icon">üè∞</div>
                <div class="game-title">Azrok's Republic</div>
                <div class="game-desc">A politburo investment &amp; deception game for 4 players. Hidden roles, war funding, and intrigue!</div>
                <span class="game-badge badge-ready">Ready to Play</span>
            </div>
            <div class="game-card" role="button" tabindex="0" onclick="selectGame('team_supreme_scribbles')" onkeydown="if(event.key==='Enter')selectGame('team_supreme_scribbles')">
                <div class="game-icon">üé®</div>
                <div class="game-title">Team Supreme Scribbles</div>
                <div class="game-desc">A Pictionary-style drawing &amp; guessing game. No player cap ‚Äî grab the whole crew!</div>
                <span class="game-badge badge-ready">Ready to Play</span>
            </div>
            <div class="game-card disabled" role="button" aria-disabled="true" tabindex="-1">
                <div class="game-icon">ü™µ</div>
                <div class="game-title">Ore, Wood &amp; Offer Letters</div>
                <div class="game-desc">A resource trading and negotiation game. Trade your way to victory!</div>
                <span class="game-badge badge-soon">Coming Soon</span>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby" class="screen">
        <button class="back-link" onclick="backToHub()">‚Üê Back to Games</button>
        <h2 id="lobbyTitle">Enter the Lobby</h2>
        <input type="text" id="playerName" placeholder="Your name" maxlength="20">
        <input type="text" id="roomId" placeholder="Room name" maxlength="20">
        <select id="numPlayers">
            <option value="2">2 Players</option>
            <option value="3">3 Players</option>
            <option value="4">4 Players</option>
        </select>
        <button onclick="createRoom()">Create Room</button>
        <button onclick="refreshRooms()" style="background:#0f3460;">Refresh Rooms</button>
        <div id="roomList" class="room-list"></div>
    </div>

    <!-- Placeholder Screen (for coming-soon games) -->
    <div id="placeholder" class="screen">
        <button class="back-link" onclick="backToHub()">‚Üê Back to Games</button>
        <div class="placeholder-content">
            <div class="placeholder-icon">ü™µ</div>
            <h2>Ore, Wood &amp; Offer Letters</h2>
            <p>This game is coming soon! Check back later for updates.</p>
            <button onclick="backToHub()" style="background:#e94560;color:#fff;padding:12px 28px;border:none;border-radius:8px;font-size:1em;font-weight:bold;cursor:pointer;">Back to Games</button>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting" class="screen">
        <h2>Waiting for Players...</h2>
        <p id="waitingInfo"></p>
        <div id="playerList" class="player-list"></div>
    </div>

    <!-- Game Screen -->
    <div id="game" class="screen">
        <div class="info-bar">
            <div class="info-item"><div class="label">Level</div><span id="levelDisplay">1</span></div>
            <div class="info-item"><div class="label">Lives</div><span id="livesDisplay">‚ù§Ô∏è 2</span></div>
            <div class="info-item"><div class="label">Stars</div><span id="starsDisplay">‚≠ê 1</span></div>
            <div class="info-item"><div class="label">Cards Left</div><span id="cardsLeft">0</span></div>
        </div>

        <div class="pile">
            <h3>Played Cards</h3>
            <div id="playedPile"></div>
        </div>

        <div class="hand">
            <h3>Your Hand</h3>
            <div id="yourHand"></div>
        </div>

        <button class="star-btn" id="starBtn" onclick="useStar()">‚≠ê Use Throwing Star</button>
        <button class="next-btn" id="nextBtn" onclick="nextLevel()" style="display:none;">Next Level ‚û°Ô∏è</button>
    </div>

    <!-- Azrok's Republic Game Screen -->
    <div id="azrokGame" class="screen">
        <div class="info-bar">
            <div class="info-item"><div class="label">Round</div><span id="azrokRound">0/10</span></div>
            <div class="info-item"><div class="label">War Failures</div><span id="azrokWarFails">‚öîÔ∏è 0/3</span></div>
            <div class="info-item"><div class="label">People Pot</div><span id="azrokPot">$0</span></div>
            <div class="info-item"><div class="label">Your Money</div><span id="azrokMoney">$0</span></div>
            <div class="info-item"><div class="label">War Cost</div><span id="azrokWarCost">$0</span></div>
        </div>

        <div id="azrokRoleInfo" class="role-info">
            <div class="role-label">Your Role</div>
            <div class="role-value">‚Äî</div>
            <div class="sector-value">Sector: ‚Äî</div>
        </div>

        <div id="azrokTurnInfo" class="turn-info"></div>

        <div id="azrokPlayerTable"></div>

        <div id="azrokActions" class="actions-panel" style="display:none;">
            <h3>Your Actions</h3>
            <div class="action-row">
                <input type="number" id="investAmount" class="action-input" placeholder="$" min="1">
                <button class="action-btn invest" onclick="investPeople()">Invest in People</button>
            </div>
            <div class="action-row">
                <button class="action-btn improve" onclick="investImprovement()">Improve Labor Tools ($7)</button>
            </div>
            <div class="action-row">
                <select id="taxTarget" class="action-select">
                    <option value="">Select player...</option>
                </select>
                <button class="action-btn tax" onclick="useTax()">Tax a Player ($1)</button>
            </div>
            <div class="action-row">
                <button class="action-btn powder" onclick="buyPowderCharge()">Buy Powder Charge ($12)</button>
            </div>
            <div class="action-row">
                <button class="action-btn dagger" onclick="buyAzroksDagger()">Buy Azrok's Dagger ($14)</button>
            </div>
            <div class="action-row">
                <button class="action-btn end-turn" onclick="endTurn()">End Turn</button>
            </div>
        </div>

        <div id="azrokResolution" style="display:none;margin:16px auto;text-align:center;">
            <button class="action-btn resolve" onclick="resolveRound()">Resolve Round</button>
        </div>

        <div id="azrokNextRound" style="display:none;margin:16px auto;text-align:center;">
            <button class="action-btn next-round" onclick="startNextRound()">Start Next Round</button>
        </div>
    </div>

    <!-- Team Supreme Scribbles Game Screen -->
    <div id="scribblesGame" class="screen">
        <div class="info-bar">
            <div class="info-item"><div class="label">Round</div><span id="scribblesRound">0/3</span></div>
            <div class="info-item"><div class="label">Drawer</div><span id="scribblesDrawer">‚Äî</span></div>
            <div class="info-item"><div class="label">Your Score</div><span id="scribblesMyScore">0</span></div>
        </div>

        <!-- Drawer view: shows the word -->
        <div id="scribblesDrawerView" style="display:none;">
            <div class="scribbles-word-card">
                <div class="word-label">‚úèÔ∏è You are the drawer! Draw this word:</div>
                <div class="word-value" id="scribblesWord">‚Äî</div>
            </div>
            <div style="margin:16px;">
                <button class="action-btn end-turn" onclick="scribblesEndDrawing()">‚è≠Ô∏è Skip / End Drawing</button>
            </div>
        </div>

        <!-- Guesser view: input to guess -->
        <div id="scribblesGuesserView" style="display:none;">
            <div class="scribbles-waiting-card">
                <div class="waiting-icon">üé®</div>
                <div class="drawer-name" id="scribblesDrawerName">‚Äî is drawing...</div>
                <div class="waiting-text">Try to guess what they're drawing!</div>
            </div>
            <div class="scribbles-guess-area">
                <input type="text" id="scribblesGuessInput" placeholder="Type your guess..." maxlength="50" onkeydown="if(event.key==='Enter')scribblesGuess()">
                <button onclick="scribblesGuess()">Guess</button>
            </div>
        </div>

        <!-- Round end view -->
        <div id="scribblesRoundEnd" style="display:none;">
            <div class="scribbles-round-end">
                <div>The word was:</div>
                <div class="revealed-word" id="scribblesRevealedWord">‚Äî</div>
                <button class="action-btn next-round" onclick="scribblesStartRound()">‚ñ∂Ô∏è Next Round</button>
            </div>
        </div>

        <!-- Game over view -->
        <div id="scribblesGameOver" style="display:none;">
            <div class="scribbles-round-end">
                <h2 style="color:#e94560;">üéâ Game Over!</h2>
                <p style="color:#999;margin:8px 0;">Final Scores below</p>
            </div>
        </div>

        <!-- Score table (always visible) -->
        <div id="scribblesScoreTable"></div>
    </div>

    <!-- Game Over Overlay -->
    <div id="gameOverOverlay" class="overlay">
        <div class="overlay-content">
            <h2 id="gameOverTitle"></h2>
            <p id="gameOverMsg"></p>
            <button onclick="backToHub()" style="background:#e94560;color:#fff;">Back to Games</button>
        </div>
    </div>

    <!-- Log -->
    <div id="log"></div>

    <script>
        let ws = null;
        let myPlayerId = null;
        let myRoomId = null;
        let selectedGameType = null;
        const AZROK_GAME_STATES = ['investment_phase', 'resolution_phase', 'round_end', 'game_won_republic', 'game_won_drow', 'setup'];
        const SCRIBBLES_GAME_STATES = ['waiting', 'drawing', 'round_end', 'game_over'];
        let lastScribblesWord = null;

        function getWsUrl() {
            const loc = window.location;
            const proto = loc.protocol === 'https:' ? 'wss:' : 'ws:';
            return proto + '//' + loc.host;
        }

        function connect() {
            return new Promise((resolve, reject) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    resolve();
                    return;
                }
                ws = new WebSocket(getWsUrl());
                ws.onopen = () => resolve();
                ws.onerror = (e) => reject(e);
                ws.onclose = () => {
                    addLog('Disconnected from server', 'error');
                    ws = null;
                };
                ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
            });
        }

        function send(obj) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(obj));
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function addLog(msg, type) {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.className = type ? 'log-' + type : '';
            div.textContent = msg;
            log.prepend(div);
            if (log.children.length > 50) log.removeChild(log.lastChild);
        }

        function selectGame(gameType) {
            if (gameType === 'ore_wood_offer_letters') {
                showScreen('placeholder');
                return;
            }
            selectedGameType = gameType;
            const titles = {
                'the_mind': 'üß† The Mind ‚Äî Lobby',
                'azroks_republic': 'üè∞ Azrok\'s Republic ‚Äî Lobby',
                'team_supreme_scribbles': 'üé® Team Supreme Scribbles ‚Äî Lobby'
            };
            document.getElementById('lobbyTitle').textContent = titles[gameType] || 'Lobby';

            const numPlayersSelect = document.getElementById('numPlayers');
            numPlayersSelect.innerHTML = '';
            if (gameType === 'azroks_republic') {
                var opt = document.createElement('option');
                opt.value = 4;
                opt.textContent = '4 Players';
                numPlayersSelect.appendChild(opt);
                numPlayersSelect.disabled = true;
            } else if (gameType === 'team_supreme_scribbles') {
                for (var n = 1; n <= 20; n++) {
                    var opt = document.createElement('option');
                    opt.value = n;
                    opt.textContent = n + (n === 1 ? ' Player' : ' Players');
                    numPlayersSelect.appendChild(opt);
                }
                numPlayersSelect.value = '4';
                numPlayersSelect.disabled = false;
            } else {
                for (var n = 2; n <= 4; n++) {
                    var opt = document.createElement('option');
                    opt.value = n;
                    opt.textContent = n + ' Players';
                    numPlayersSelect.appendChild(opt);
                }
                numPlayersSelect.disabled = false;
            }

            showScreen('lobby');
            refreshRooms();
        }

        function backToHub() {
            document.getElementById('gameOverOverlay').classList.remove('active');
            if (ws) ws.close();
            ws = null;
            myPlayerId = null;
            myRoomId = null;
            selectedGameType = null;
            document.getElementById('numPlayers').disabled = false;
            showScreen('hub');
        }

        async function createRoom() {
            await connect();
            const name = document.getElementById('playerName').value.trim() || 'Player';
            const roomId = document.getElementById('roomId').value.trim();
            const numPlayers = document.getElementById('numPlayers').value;
            if (!roomId) { addLog('Please enter a room name', 'error'); return; }
            send({ action: 'create_room', room_id: roomId, num_players: parseInt(numPlayers), name: name, game_type: selectedGameType });
        }

        async function joinRoom(roomId) {
            await connect();
            const name = document.getElementById('playerName').value.trim() || 'Player';
            send({ action: 'join_room', room_id: roomId, name: name });
        }

        async function refreshRooms() {
            await connect();
            send({ action: 'list_rooms' });
        }

        function playCard(card) {
            send({ action: 'play_card', card: card });
        }

        function useStar() {
            send({ action: 'use_star' });
        }

        function nextLevel() {
            send({ action: 'next_level' });
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'room_joined':
                    myPlayerId = msg.player_id;
                    myRoomId = msg.room_id;
                    selectedGameType = msg.game_type || selectedGameType;
                    document.getElementById('waitingInfo').textContent =
                        'Room: ' + msg.room_id + ' ‚Äî ' + msg.current_players + '/' + msg.num_players + ' players';
                    showScreen('waiting');
                    addLog('Joined room ' + msg.room_id + ' as ' + msg.player_name, 'success');
                    break;

                case 'player_joined':
                    document.getElementById('waitingInfo').textContent =
                        'Room: ' + myRoomId + ' ‚Äî ' + msg.current_players + '/' + msg.num_players + ' players';
                    addLog(msg.player_name + ' joined the room', 'info');
                    break;

                case 'game_started':
                    if (selectedGameType === 'azroks_republic') {
                        showScreen('azrokGame');
                    } else if (selectedGameType === 'team_supreme_scribbles') {
                        showScreen('scribblesGame');
                    } else {
                        showScreen('game');
                    }
                    addLog('Game started!', 'success');
                    break;

                case 'game_state':
                    if (selectedGameType === 'team_supreme_scribbles' && msg.state && SCRIBBLES_GAME_STATES.includes(msg.state)) {
                        updateScribblesUI(msg);
                    } else if (msg.state && AZROK_GAME_STATES.includes(msg.state)) {
                        updateAzrokUI(msg);
                    } else {
                        updateGameUI(msg);
                    }
                    break;

                case 'card_played':
                    if (msg.success) {
                        addLog(msg.player_name + ' played card ' + msg.card, 'success');
                    } else {
                        addLog(msg.player_name + ' played ' + msg.card + ' out of order! ' + msg.message, 'error');
                    }
                    break;

                case 'star_used':
                    if (msg.success) {
                        let details = Object.values(msg.discarded).map(d => d.name + ': ' + d.card).join(', ');
                        addLog('Throwing star used! Discarded: ' + details, 'info');
                    }
                    break;

                case 'level_started':
                    document.getElementById('nextBtn').style.display = 'none';
                    addLog('Level ' + msg.level + ' started!', 'success');
                    break;

                case 'room_list':
                    renderRoomList(msg.rooms);
                    break;

                case 'player_left':
                    addLog(msg.player_name + ' left the room', 'error');
                    break;

                case 'action_result':
                    if (msg.action === 'scribbles_guess') {
                        if (msg.correct) {
                            addLog((msg.player_name || 'Someone') + ' guessed correctly! ' + msg.message, 'success');
                            // Extract revealed word from message like "Correct! The word was 'xyz'"
                            var wordMatch = msg.message && msg.message.match(/word was '(.+)'/);
                            if (wordMatch) lastScribblesWord = wordMatch[1];
                        } else {
                            addLog((msg.player_name || 'Someone') + ': ' + msg.message, 'info');
                        }
                    } else if (msg.action === 'scribbles_end_drawing') {
                        addLog(msg.message, 'info');
                        // Extract revealed word from message like "Round ended. The word was 'xyz'"
                        var wordMatch2 = msg.message && msg.message.match(/word was '(.+)'/);
                        if (wordMatch2) lastScribblesWord = wordMatch2[1];
                    } else if (msg.action === 'scribbles_start_round') {
                        if (msg.result && msg.result.success) {
                            if (msg.result.game_over) {
                                addLog('Game over!', 'info');
                            } else {
                                addLog('New round started!', 'success');
                            }
                        } else if (msg.result) {
                            addLog(msg.result.message || 'Action failed', 'error');
                        }
                    } else if (msg.success !== undefined) {
                        addLog((msg.player_name ? msg.player_name + ': ' : '') + msg.message, msg.success ? 'success' : 'error');
                    } else if (msg.result) {
                        if (msg.result.success) {
                            addLog(msg.action.replace('_', ' ') + ' completed', 'success');
                        } else {
                            addLog(msg.result.message || 'Action failed', 'error');
                        }
                    }
                    break;

                case 'error':
                    addLog(msg.message, 'error');
                    break;
            }
        }

        function updateGameUI(state) {
            if (!state || state.state === 'waiting') return;

            document.getElementById('levelDisplay').textContent = state.current_level;
            document.getElementById('livesDisplay').textContent = '‚ù§Ô∏è ' + state.lives;
            document.getElementById('starsDisplay').textContent = '‚≠ê ' + state.throwing_stars;
            document.getElementById('cardsLeft').textContent = state.cards_in_play;

            // Render played pile (show last 10 cards)
            const pile = document.getElementById('playedPile');
            const cards = state.played_pile || [];
            const recent = cards.slice(-10);
            pile.innerHTML = recent.map(c => '<div class="pile-card">' + c + '</div>').join('');

            // Render hand
            const hand = document.getElementById('yourHand');
            const myCards = state.your_hand || [];
            hand.innerHTML = myCards.map(c =>
                '<button class="card-btn" onclick="playCard(' + c + ')">' + c + '</button>'
            ).join('');

            // Star button
            const starBtn = document.getElementById('starBtn');
            starBtn.disabled = state.throwing_stars <= 0 || state.state !== 'in_progress';

            // Level complete
            const nextBtn = document.getElementById('nextBtn');
            if (state.state === 'level_complete') {
                nextBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'none';
            }

            // Game over
            if (state.state === 'game_won') {
                document.getElementById('gameOverTitle').textContent = 'üéâ You Won!';
                document.getElementById('gameOverMsg').textContent = 'Congratulations! You completed all 12 levels!';
                document.getElementById('gameOverOverlay').classList.add('active');
            } else if (state.state === 'game_lost') {
                document.getElementById('gameOverTitle').textContent = 'üíî Game Over';
                document.getElementById('gameOverMsg').textContent = 'You ran out of lives. Better luck next time!';
                document.getElementById('gameOverOverlay').classList.add('active');
            }
        }

        function renderRoomList(rooms) {
            const list = document.getElementById('roomList');
            // Filter rooms to only show those matching the selected game type
            const filtered = rooms.filter(r => r.game_type === selectedGameType);
            if (filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;">No rooms available. Create one!</p>';
                return;
            }
            list.innerHTML = filtered.map(r => {
                const canJoin = !r.in_progress && r.current_players < r.num_players;
                return '<div class="room-item"><span>' + r.room_id + ' (' + r.current_players + '/' + r.num_players + ')' +
                    (r.in_progress ? ' - In Progress' : '') + '</span>' +
                    (canJoin ? '<button onclick="joinRoom(\'' + r.room_id + '\')">Join</button>' : '') +
                    '</div>';
            }).join('');
        }

        // Azrok's Republic action functions
        function investPeople() {
            const amount = parseInt(document.getElementById('investAmount').value);
            if (!amount || amount <= 0) { addLog('Enter a valid amount', 'error'); return; }
            send({ action: 'invest_people', amount: amount });
        }

        function investImprovement() {
            send({ action: 'invest_improvement' });
        }

        function useTax() {
            const targetId = parseInt(document.getElementById('taxTarget').value);
            if (isNaN(targetId)) { addLog('Select a target', 'error'); return; }
            send({ action: 'use_tax', target_id: targetId });
        }

        function buyPowderCharge() {
            send({ action: 'buy_powder_charge' });
        }

        function buyAzroksDagger() {
            send({ action: 'buy_azroks_dagger' });
        }

        function endTurn() {
            send({ action: 'end_turn' });
        }

        function resolveRound() {
            send({ action: 'resolve_round' });
        }

        function startNextRound() {
            send({ action: 'start_round' });
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function updateAzrokUI(state) {
            if (!state) return;

            // Info bar
            document.getElementById('azrokRound').textContent = (state.current_round || 0) + '/' + (state.max_rounds || 10);
            document.getElementById('azrokWarFails').textContent = '‚öîÔ∏è ' + (state.war_failures || 0) + '/' + (state.max_war_failures || 3);
            document.getElementById('azrokPot').textContent = '$' + (state.people_pot || 0);
            document.getElementById('azrokMoney').textContent = '$' + (state.your_money !== undefined ? state.your_money : 0);
            document.getElementById('azrokWarCost').textContent = '$' + (state.war_cost || 0);

            // Role info (use textContent via DOM methods to avoid XSS)
            var roleInfo = document.getElementById('azrokRoleInfo');
            if (state.your_role) {
                var isAgent = state.your_role === 'Agent of the Drow';
                roleInfo.innerHTML = '';
                var labelDiv = document.createElement('div');
                labelDiv.className = 'role-label';
                labelDiv.textContent = 'Your Role';
                var valueDiv = document.createElement('div');
                valueDiv.className = 'role-value';
                valueDiv.style.color = isAgent ? '#c0392b' : '#2ecc71';
                valueDiv.textContent = state.your_role;
                var sectorDiv = document.createElement('div');
                sectorDiv.className = 'sector-value';
                sectorDiv.textContent = 'Sector: ' + (state.your_sector || '');
                roleInfo.appendChild(labelDiv);
                roleInfo.appendChild(valueDiv);
                roleInfo.appendChild(sectorDiv);
            }

            // Turn info
            var turnInfo = document.getElementById('azrokTurnInfo');
            var currentPlayer = state.current_player;
            var isMyTurn = currentPlayer === state.your_id;

            if (state.state === 'investment_phase') {
                var currentName = state.player_names && state.player_names[currentPlayer] ? state.player_names[currentPlayer] : 'Player ' + currentPlayer;
                if (isMyTurn) {
                    turnInfo.textContent = 'üü¢ It\'s YOUR turn!';
                    turnInfo.className = 'turn-info your-turn';
                } else {
                    turnInfo.textContent = 'Waiting for ' + currentName + '...';
                    turnInfo.className = 'turn-info';
                }
            } else if (state.state === 'resolution_phase') {
                turnInfo.textContent = 'üìã Resolution Phase ‚Äî Click to resolve the round';
                turnInfo.className = 'turn-info';
            } else if (state.state === 'round_end') {
                turnInfo.textContent = '‚úÖ Round complete! Start the next round.';
                turnInfo.className = 'turn-info';
            } else {
                turnInfo.textContent = '';
                turnInfo.className = 'turn-info';
            }

            // Player table (escape user-provided names)
            var table = document.getElementById('azrokPlayerTable');
            var html = '<table class="player-table"><tr><th>Player</th><th>Sector</th><th>Money</th><th>Tools</th></tr>';
            var sectors = state.sectors || {};
            var money = state.player_money || {};
            var levels = state.improvement_levels || {};
            var names = state.player_names || {};

            for (var i = 0; i < (state.num_players || 4); i++) {
                var isCurrent = (currentPlayer === i && state.state === 'investment_phase');
                var isMe = (i === state.your_id);
                var classes = [];
                if (isCurrent) classes.push('active-player');
                if (isMe) classes.push('is-you');
                var genSec = state.general_secretary === i ? ' üëë' : '';
                html += '<tr class="' + classes.join(' ') + '">' +
                    '<td>' + escapeHtml(names[i] || 'Player ' + i) + genSec + (isMe ? ' (you)' : '') + '</td>' +
                    '<td>' + escapeHtml(sectors[i] || '') + '</td>' +
                    '<td>$' + (money[i] !== undefined ? money[i] : '?') + '</td>' +
                    '<td>' + (levels[i] || 1) + 'X</td>' +
                    '</tr>';
            }
            html += '</table>';
            table.innerHTML = html;

            // Actions panel (only during investment phase and your turn)
            var actionsPanel = document.getElementById('azrokActions');
            if (state.state === 'investment_phase' && isMyTurn) {
                actionsPanel.style.display = 'block';
                var taxSelect = document.getElementById('taxTarget');
                if (taxSelect) {
                    taxSelect.innerHTML = '';
                    var defaultOpt = document.createElement('option');
                    defaultOpt.value = '';
                    defaultOpt.textContent = 'Select player...';
                    taxSelect.appendChild(defaultOpt);
                    for (var j = 0; j < (state.num_players || 4); j++) {
                        if (j !== state.your_id) {
                            var opt = document.createElement('option');
                            opt.value = j;
                            opt.textContent = names[j] || 'Player ' + j;
                            taxSelect.appendChild(opt);
                        }
                    }
                }
            } else {
                actionsPanel.style.display = 'none';
            }

            // Resolution panel
            var resPanel = document.getElementById('azrokResolution');
            resPanel.style.display = (state.state === 'resolution_phase') ? 'block' : 'none';

            // Next round panel
            var nextPanel = document.getElementById('azrokNextRound');
            nextPanel.style.display = (state.state === 'round_end') ? 'block' : 'none';

            // Game over
            if (state.state === 'game_won_republic') {
                document.getElementById('gameOverTitle').textContent = 'üè∞ The Republic Wins!';
                document.getElementById('gameOverMsg').textContent = 'The Brothers of the Republic have prevailed!';
                document.getElementById('gameOverOverlay').classList.add('active');
            } else if (state.state === 'game_won_drow') {
                document.getElementById('gameOverTitle').textContent = 'üó°Ô∏è The Drow Win!';
                document.getElementById('gameOverMsg').textContent = 'The Agents of the Drow have sabotaged the Republic!';
                document.getElementById('gameOverOverlay').classList.add('active');
            }
        }

        // Team Supreme Scribbles action functions
        function scribblesGuess() {
            var input = document.getElementById('scribblesGuessInput');
            var word = input.value.trim();
            if (!word) { addLog('Enter a guess', 'error'); return; }
            send({ action: 'scribbles_guess', word: word });
            input.value = '';
        }

        function scribblesEndDrawing() {
            send({ action: 'scribbles_end_drawing' });
        }

        function scribblesStartRound() {
            send({ action: 'scribbles_start_round' });
        }

        function updateScribblesUI(state) {
            if (!state) return;

            // Info bar
            document.getElementById('scribblesRound').textContent = (state.current_round || 0) + '/' + (state.num_rounds || 3);
            var drawerName = state.player_names && state.player_names[state.current_drawer] ? state.player_names[state.current_drawer] : 'Player ' + state.current_drawer;
            document.getElementById('scribblesDrawer').textContent = drawerName;
            var myScore = state.scores && state.your_id !== undefined ? (state.scores[state.your_id] || 0) : 0;
            document.getElementById('scribblesMyScore').textContent = myScore;

            var isDrawer = state.your_id === state.current_drawer;

            // Track word for round-end reveal
            if (state.your_word) {
                lastScribblesWord = state.your_word;
            }

            // Hide all sub-views
            document.getElementById('scribblesDrawerView').style.display = 'none';
            document.getElementById('scribblesGuesserView').style.display = 'none';
            document.getElementById('scribblesRoundEnd').style.display = 'none';
            document.getElementById('scribblesGameOver').style.display = 'none';

            if (state.state === 'drawing') {
                if (isDrawer) {
                    document.getElementById('scribblesDrawerView').style.display = 'block';
                    document.getElementById('scribblesWord').textContent = state.your_word || '‚Äî';
                } else {
                    document.getElementById('scribblesGuesserView').style.display = 'block';
                    document.getElementById('scribblesDrawerName').textContent = escapeHtml(drawerName) + ' is drawing...';
                }
            } else if (state.state === 'round_end') {
                document.getElementById('scribblesRoundEnd').style.display = 'block';
                document.getElementById('scribblesRevealedWord').textContent = lastScribblesWord || '?';
            } else if (state.state === 'game_over') {
                document.getElementById('scribblesGameOver').style.display = 'block';
            }

            // Score table (always visible)
            var table = document.getElementById('scribblesScoreTable');
            var html = '<table class="scribbles-score-table"><tr><th>Player</th><th>Score</th></tr>';
            var names = state.player_names || {};
            var scores = state.scores || {};

            for (var i = 0; i < (state.num_players || 1); i++) {
                var isMe = (i === state.your_id);
                var isDrawerRow = (i === state.current_drawer && state.state === 'drawing');
                var classes = [];
                if (isDrawerRow) classes.push('is-drawer');
                if (isMe) classes.push('is-you');
                html += '<tr class="' + classes.join(' ') + '">' +
                    '<td>' + escapeHtml(names[i] || 'Player ' + i) + (isMe ? ' (you)' : '') + (isDrawerRow ? ' üé®' : '') + '</td>' +
                    '<td>' + (scores[i] !== undefined ? scores[i] : 0) + '</td>' +
                    '</tr>';
            }
            html += '</table>';
            table.innerHTML = html;
        }

        // No auto-connect on load ‚Äî user picks a game first from the hub
    </script>
</body>
</html>
